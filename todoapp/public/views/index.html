<!DOCTYPE html>
<html lang="ja" class="h-100">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="Description" content="Enter your description here" />
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.0.0-alpha1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css">
    <link rel="stylesheet" href="../stylesheets/style.css" />
    <link rel=”stylesheet” href=”css/bootstrap.css”>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <title>TodoApp</title>
  </head>
  <body class="h-100 bg-white">
    <main class="h-100">
      <div class="page-wrapper d-flex flex-row h-100 w-100">
        <nav class="sidebar bg-light bg-gradient border-right h-100">
          <div class="brand p-4">
            <h4>
                Work Out
            </h4>
          </div>
          <ul class="nav flex-column m-o p-3">
            <li class="nav-item mb-2 border-bottom">
                <a href="" class="nav-link">カレンダー</a>
            </li>
            <li class="nav-item mb-2 border-bottom">
                <a href="" class="nav-link w-100 h-100">タスク管理</a>
            </li>
            <li class="nav-item mb-2 border-bottom">
              <a href="" class="nav-link w-100 h-100">ワークスペース</a>
            </li>
            <li class="nav-item mb-2 border-bottom">
              <a href="" class="nav-link w-100 h-100">分析</a>
            </li>
          </ul>
        </nav>
        <div class="page-content w-100">
          <nav class="navbar px-3 w-100 bg-light border-bottom">
            <div class="navbar-brand toggle-menu">
              <button class="btn btn-light btn-sm" id="sidebarToggler">
                <i class="fas fa-bars fa-lg"></i>
              </button>
            </div>
            <ul class="navbar-nav d-flex flex-row">
              <li class="nav-item ml-3 text-muted">
                Home
              </li>
              <li class="nav-item ml-3 text-muted">
                Test
              </li>
              <li class="nav-item ml-3 text-muted">
                Login
              </li>
            </ul>
          </nav>
            <div class="content p-3">
              <div class="page-title pb-2 ">
                <h2>タスク一覧</h2>
              </div>
              <button type="button" id="reflect-task" class="btn btn-secondary" data-toggle="modal" data-target="#create-modal">新規作成</button>
              <div class="w-100 my-3">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th scope="col" class="col">
                      </th>
                      <th scope="col" id="0" data-asc="" class="col4 sort" sortable>タスク名
                        <i class="fa fa-sort"></i>
                      </th>
                      <th scope="col" id="1" data-asc="" class="col2 sort" sortable>カテゴリ
                        <i class="fa fa-sort"></i>
                      </th>
                      <th scope="col" id="2" data-asc="" class="col2 sort" sortable>締切日
                        <i class="fa fa-sort"></i>
                      </th>
                      <th scope="col" id="3" data-asc="" class="col2 sort" sortable>更新日
                        <i class="fa fa-sort"></i>
                      </th>
                      <th scope="col" id="4" data-asc="" class="col sort" sortable>進捗
                        <i class="fa fa-sort"></i>
                      </th>
                      <th scope="col" class="col">更新</th>
                      <th scope="col" class="col">削除</th>
                    </tr>
                  </thead>
                  <tbody id="tasks">
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
    </main>
    <div
      class="modal fade"
      id="create-modal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="create-modal"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="create-modal">新規登録</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
                <label for="task">タスク</label>
                <input type="text" class="form-control" id="task" name="task" />
              </div>
              <div class="form-group">
                <label for="deadline">期限</label>
                <input type="date" class="form-control" id="deadline" name="deadline" />
              </div>
              <div class="form-group">
                <label for="category">カテゴリ</label>
                <select class="form-control" id="category" name="category">
                  <option value="1">生活</option>
                  <option value="2">勉強</option>
                  <option value="3">仕事</option>
                  <option value="4">趣味</option>
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              キャンセル
            </button>
            <button
              type="button"
              id="create-task"
              data-dismiss="modal"
              class="btn btn-primary"
            >
              登録
            </button>
          </div>
        </div>
      </div>
    </div>
    <div
      class="modal fade"
      id="update-modal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="update-modal"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="update-modal">更新</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
                <label for="update-taskname">タスク</label>
                <input
                  type="text"
                  class="form-control"
                  id="update-taskname"
                  name="update-taskname"
                />
              </div>
              <div class="form-group">
                <label for="update-deadline">期限</label>
                <input
                  type="date"
                  class="form-control"
                  id="update-deadline"
                  name="update-deadline"
                />
              </div>
              <div class="form-group">
                <label for="category">カテゴリ</label>
                <select class="form-control" id="update-category" name="update-category">
                  <option value="1">生活</option>
                  <option value="2">勉強</option>
                  <option value="3">仕事</option>
                  <option value="4">趣味</option>
                </select>
              </div>
              <div class="form-group">
                <label for="category">ステータス</label>
                <select class="form-control" id="update-status" name="update-status">
                  <option value="0">作業前</option>
                  <option value="1">作業中</option>
                  <option value="2">完了</option>
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              キャンセル
            </button>
            <button
              type="button"
              data-dismiss="modal"
              class="btn btn-primary"
              id="update-task"
            >
              保存
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- モーダル 更新 END -->
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script
      src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
      integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>

    <script src="../javascripts/index.js"></script>

    <script>
      var user_id=1;
      var Mode="view";
      var Task_id;
      var Task_name;
      var Deadline;
      var Category_id;
      var Status_id;

      function generate_option(name,num,response,i,type,parent){
        var option = document.createElement("option");
        option.value = num;
        option.textContent = name;
        switch(type){
          case "category_id":
            if(response[i].category_id==num){
              option.setAttribute("selected","selected");
            }
            break;
          case "status_id":
            if(response[i].status_id==num){
              option.setAttribute("selected","selected");
            }
            break;
        }
        parent.appendChild(option);
      }
      function generate_date(date_data){
        const date = new Date(date_data);
        const year = date.getFullYear();
        const month = ("0"+(date.getMonth()+1)).slice(-2);
        const day = ("0"+date.getDate()).slice(-2);
        return year+"-"+month+"-"+day;
      }
      function generate_datetime(date_data){
        const date = new Date(date_data);
        const year = date.getFullYear();
        const month = ("0"+(date.getMonth()+1)).slice(-2);
        const day = ("0"+date.getDate()).slice(-2);
        const hour = ("0"+date.getHours()).slice(-2);
        const minute = ("0"+date.getMinutes()).slice(-2);
        const second = ("0"+date.getSeconds()).slice(-2);
        return year+"-"+month+"-"+day+" "+hour+":"+minute+":"+second+".000";
      }
      function generate_table(response){
        var tbl = document.getElementById("tasks");
        for (var i = 0; i < response.length; i++) {
          var rows = document.createElement("tr");
          for (var j = 0; j < 8; j++) {
            var row = document.createElement("td");
            switch (j){
              case 0:
                row.style.cssText = "padding:0px";
                switch (response[i].category_id){
                  case 1:
                    row.style.cssText = "background-color:#dc3545";
                    break;
                  case 2:
                    row.style.cssText = "background-color:#0d6efd";
                    break;
                  case 3:
                    row.style.cssText = "background-color:#198754";
                    break;
                  case 4:
                    row.style.cssText = "background-color:#ffc107";
                    break;
                }
                break;
              case 1:
                var task_name = document.createElement("input");
                task_name.className = "task_table task_name";
                task_name.style.cssText = "border:none;";
                task_name.setAttribute("data-type","task_name");
                task_name.setAttribute("data-taskid",response[i].task_id);
                task_name.setAttribute("value",response[i].task_name);
                row.appendChild(task_name);
                break;
              case 2:
                var category = document.createElement("select");
                  generate_option("生活",1,response,i,"category_id",category);
                  generate_option("勉強",2,response,i,"category_id",category);
                  generate_option("仕事",3,response,i,"category_id",category);
                  generate_option("趣味",4,response,i,"category_id",category);
                category.style.cssText = "border:none;";
                category.setAttribute("data-type","category_name");
                category.setAttribute("data-taskid",response[i].task_id);
                category.setAttribute("id",response[i].category_id);
                category.className = "task_table category_name";
                row.appendChild(category);
                break;
              case 3:
                var deadline = document.createElement("input");
                deadline.className = "task_table deadline";
                deadline.style.cssText = "border:none;";
                deadline.setAttribute("type","date");
                deadline.setAttribute("data-type","deadline");
                deadline.setAttribute("data-taskid",response[i].task_id);
                deadline.value = generate_date(response[i].deadline);
                row.appendChild(deadline);
                break;
              case 4:
                var update_at = document.createElement("p");
                update_at.style.cssText = "border:none;";
                update_at.className = "task_table updated_at";
                update_at.setAttribute("data-type","updated_at");
                update_at.setAttribute("data-taskid",response[i].task_id);
                if (response[i].updated_at!==null){
                  update_at.textContent = generate_date(response[i].updated_at);
                }
                row.appendChild(update_at);
                break;
              case 5:
                var status = document.createElement("select");
                  generate_option("作業前",0,response,i,"status_id",status);
                  generate_option("作業中",1,response,i,"status_id",status);
                  generate_option("完了",2,response,i,"status_id",status);
                status.style.cssText = "border:none;";
                status.className = "task_table status_name";
                status.setAttribute("data-type","status");
                status.setAttribute("data-taskid",response[i].task_id);
                status.setAttribute("id",response[i].status_id);
                row.appendChild(status);
                break;
              case 6:
                var updatebtn = document.createElement('button');
                updatebtn.className = "btn btn-light btn-sm update";
                updatebtn.type = 'button';
                updatebtn.setAttribute("value",i);
                updatebtn.setAttribute("data-taskid",response[i].task_id);
                var input = document.createElement('i');
                input.className = "bi bi-pen";
                updatebtn.appendChild(input);
                row.appendChild(updatebtn);
                break;
              case 7:
                var deletebtn = document.createElement('button');
                deletebtn.type = 'button';
                deletebtn.setAttribute("value",i);
                deletebtn.setAttribute("data-taskid",response[i].task_id);
                deletebtn.className = "btn btn-light btn-sm delete";
                var input = document.createElement('i');
                input.className = "bi bi-trash";
                deletebtn.appendChild(input);
                row.appendChild(deletebtn);
                break;
            }
            rows.appendChild(row);
          }
          tbl.appendChild(rows);
        }
      }
      // 一覧取得
      $(async function () {
        const response = await httpGet(
          "//" + window.location.host + "/api/tasks"+"/"+user_id
        );
        generate_table(response);
      });
      
      async function update_data(task_name,deadline,category,status,task_id){
        const data = {
          taskName: task_name,
          deadLine: deadline,
          category: category,
          status: status,
        };
        const response = await httpUpdate(
          "//" + window.location.host + "/api/tasks",
          data,
          user_id,
          task_id
        );
        console.log(response);
        location.reload();
      }

      //更新2
      $(document).on("change",".task_table", async function () {
        Task_id = Number($(this).data('taskid'));
        var task_data = await httpGet(
          "//" + window.location.host + "/api/tasks"+"/"+user_id+"/"+Task_id
        );
        Mode = "update";
        
        $(this).css('background-color','rgb(240, 220, 120)');
        $(this).parents("tr").addClass("edited");
        $(this).parents("tr").find(".update").addClass("push");
        $(this).parents("tr").find(".update").css('background-color','rgb(120, 180, 120)');
        Task_name=$(this).parents("tr").find(".task_name").val();
        Category_id=Number($(this).parents("tr").find(".category_name").val());
        Deadline =generate_datetime($(this).parents("tr").find(".deadline").val());
        Status_id=Number($(this).parents("tr").find(".status_name").val());
      });

      $(document).on("click", function (event) {
        if(!$(event.target).closest('.edited').length) {
          if(Mode=="update"){
            location.reload();
            Mode = "view";
          }
        } else {
          if($(event.target).closest('.push').length) {
            if(Mode=="update"){
              update_data(Task_name,Deadline,Category_id,Status_id,Task_id);
              Mode = "view";
            }
          }
        }
      });
     
      // 削除
      $(document).on("click",".delete", async function () {
        var task_id = $(this).data("taskid");
        const response2 = await httpDelete(
          "//" + window.location.host + "/api/tasks",
          user_id,
          task_id
        );
        location.reload();
      });

      // 新規登録
      $("#create-task").on("click", async function () {
        const data = {
          user_id: 2,
          taskName: $("[name=task]").val(),
          deadline: $("[name=deadline]").val(),
          category: $("[name=category]").val(),
        };
        const response = await httpPost(
          "//" + window.location.host + "/api/tasks",
          data
        );
        console.log(response);
        location.reload();
      });

      // ソート
      $(".sort").on("click", async function () {
        var sort = Number($(this).attr('id'));
        var asc = $(this).data('asc');
        $('th').data('asc', "");
        if(asc == "" || asc == 0){
          asc = 1;
          $(this).data('asc', 1);
        }else{
          asc = 0;
          $(this).data('asc', 0);
        }
        const response = await httpGet(
          "//" + window.location.host + "/api/tasks"+"/"+user_id+"/"+sort+"/"+asc
        );
        var tbl = document.getElementById("tasks");
        
        tbllen=tbl.childNodes.length;
        for (var i=0;i<tbllen;i++){
          var row = tbl.childNodes[0];
          tbl.removeChild(row);
        }
        generate_table(response);
      });
    </script>
  </body>
</html>